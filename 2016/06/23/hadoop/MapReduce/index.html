
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="hadoop,MapReduce," />
  

  
    <meta name="description" content="一起成长" />
  
  
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>MapReduce [ 小彩鸟 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="/images/logo.png">
    <span class="title">小彩鸟</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
  </ul>
   
</nav>
  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        MapReduce
      </h1>
      <span>
        
        <time class="time" datetime="2016-06-23T04:00:00.000Z">
        2016-06-23
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
    </header>

    <div class="post-content">
      <h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>&emsp;&emsp;MapReduce是一个分布式计算框架，开发复杂累赘所以除了老项目现在生产上基本不用了，生产中用hive，spark，fink代替。但是MapReduce计算框架的设计理念，成就了很多计算框架，所以可以认为是大数据计算框架的鼻祖。<br>&emsp;&emsp;在运行一个mapreduce计算任务时候，任务过程被分为两个阶段：map阶段和reduce阶段，map是负责数据的过滤和分发，reduce负责数据的计算归并</p>
<p>大数据计算主要靠两样:内存+cpu vcore，这个可以由yarn提供</p>
<p>&emsp;&emsp;一个完整的MapReduce程序在分布式运行时有三类实例进程:</p>
<ul>
<li>MrAppMaster:负责整个程序的过程调度及状态协调</li>
<li>MapTask:负责map阶段的整个数据处理流程</li>
<li>ReduceTask:负责reduce阶段的整个数据处理流程<br/>
<br/>

</li>
</ul>
<h1 id="MapReduce详细工作流程"><a href="#MapReduce详细工作流程" class="headerlink" title="MapReduce详细工作流程"></a>MapReduce详细工作流程</h1><br/>

<h3 id="MapTask详细工作流程"><a href="#MapTask详细工作流程" class="headerlink" title="MapTask详细工作流程"></a>MapTask详细工作流程</h3><p><em>开多少个maptask完全由切片个数决定,而不是由块决定。一个切片对应一个maptask(但要注意,一个文件如果小于128M也会被切成一片的,所以切片个数也受文件数影响)</em>。默认切片大小等于块大小等于128M。<br><br/></p>
<p><img src="/img/MapReduce/maptask.png" alt="NN路径下的编辑日志和镜像文件"><br><br/></p>
<ul>
<li>Read阶段：Map Task通过RecordReader，从输入InputSplit中解析出一个个key/value。</li>
<li>Map阶段：该节点主要是将解析出的key/value交给用户编写map()函数处理，并产生一系列新的key/value。</li>
<li>map()方法后就进入了shuffle阶段<br/>
<br/>

</li>
</ul>
<h3 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h3><p>&emsp;&emsp;shuffle具体是指Map()方法之后Reduce()方法之前这段处理过程叫 Shuffle。这需要把不同机器相同key的数据聚集在一个reduce上，这其中涉及到了大量的磁盘操作和网络io，严重影响计算性能。<br>&emsp;&emsp;所以业界有句话，能不shuffle的就不要shuffle，shuffle会拉长计算的时间。</p>
<p>shuffle具体执行过程:<br>&emsp;&emsp;每个map任务都有一个环形换冲区用于存储任务输出，在默认情况下缓冲区大小是100m，此值可以通过io.sort.mb属性来调整。一旦缓冲区达到阈值(io.sort.spill.percent，默认是0.80)，一个后台线程就会把内容溢出到磁盘（在溢出到磁盘的过程中，map输出会继续写到剩余20%的缓存区中，但如果在此期间缓存区被填满了，map会被阻塞直到写磁盘过程完成。溢出过程将缓存数据写到mapred.local.dir属性指定的目录中）。在写磁盘之前，线程会首先将数据进行分区。在每个分区中，后台线程按照键进行排序(排序方式为快速排序,如果我们定义了combiner函数，排序后接着运行combiner在本地节点内存中将每个Map任务输出的中间结果按键做本地聚合(如果设置了的话)，可以减少传递给Reducer的数据量。)，每次环形缓冲区达到溢出阈值，就会新建一个溢出文件，也就是说在做map输出有几次spill就会产生多少个溢出文件，因此在map任务写完其最后一个输出记录后，会有很多溢出文件。之后溢出文件会被合并成一个已分区且已排序的输出文件。配置属性io.sort.factor控制着一次最多能合并多少流，默认值是10。在将map输出写到磁盘上过程中对其进行压缩是很好的主意，因为这样写磁盘更快，节约磁盘空间，并且减少传给reduce的数据量，但是在reduce端是需要解压缩的。在默认情况下输出是不压缩的，但只要将mapred.compress.map.output设置为true ， 就可以轻松启用此功能。使用压缩库由mapred.map.output.compression.codec指定。reduce通过http得到输出文件的分区，因为每个map的完成时间各不相同，因此只要有一个任务完成，reduce任务就开始复制其输出.这就是reduce任务的复制阶段。reduce任务有少量的复制线程，因此能够并行的取得map输出。默认值是5个线程，可以通过参数mapred.reduce.parallel.copies属性来改变。如果map输出相当小，会被复制到reduce任务的jvm内存中(缓冲区大小由mapred.job.shuffle.input.buffer.percent属性控制，指定用于此用途的堆空间占比)，否则map输出复制到磁盘。一旦内存缓冲区达到阈值大小(mapred.job.shuffle.merger.percent决定)或达到map输出阈值(mapred.inmen.merge.threhold控制)，则合并后溢出写到磁盘。注意为了合并压缩后的map输出必须再内存中解压缩。复制完所有的map数据后，reduce阶段进行归并排序(由于各个MapTask已经实现对自己的处理结果进行了局部排序)。</p>
<h4 id="shuffle优化"><a href="#shuffle优化" class="headerlink" title="shuffle优化"></a>shuffle优化</h4><br/>

<h3 id="ReduceTask详细工作流程"><a href="#ReduceTask详细工作流程" class="headerlink" title="ReduceTask详细工作流程"></a>ReduceTask详细工作流程</h3><p><img src="/img/MapReduce/reducetask.png" alt="NN路径下的编辑日志和镜像文件"></p>
<ul>
<li>之前是shuffle操作</li>
<li>Reduce阶段：执行用户自定的reduce()函数将计算结果写到HDFS上。</li>
</ul>

    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    <div id="toc-div" class="toc-article" >
   <strong class="toc-title">Index</strong>
     
       <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#定义"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MapReduce详细工作流程"><span class="toc-text">MapReduce详细工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MapTask详细工作流程"><span class="toc-text">MapTask详细工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shuffle"><span class="toc-text">Shuffle</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shuffle优化"><span class="toc-text">shuffle优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReduceTask详细工作流程"><span class="toc-text">ReduceTask详细工作流程</span></a></li></ol></li></ol></li></ol>
     
</div>
  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<div class="share" style="width: 100%;">
  <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/static/2018-12-10-qrcode_for_gh_ffacf5722095_258.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div>
  
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2016/06/01/hadoop/hdfs/" rel="next" title="HDFS">
          HDFS
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2016/07/02/hadoop/Yarn/" rel="prev" title="Yarn">
            Yarn
          </a>
          <span>〉</span>
        
      </div>
    </div>
  


    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://blog.0xff000000.com" target="_blank" rel="noopener">首页</a> |
        <a class="bottom-item" href="https://0xff000000.com" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
